<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./student-group.js" type="module"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght{400;500;600;700}&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 100vw;
            overflow-x: auto;
        }
        canvas {
            display: block;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Custom button styling */
        .action-button {
            background-color: #2563eb;
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            text-align: center;
        }
        .action-button:hover {
            background-color: #1e40af;
        }
        .download-button {
            background-color: #4b5563; /* Grayed out by default */
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            text-align: center;
        }
        .download-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .download-button:not(:disabled):hover {
            background-color: #1e40af;
        }
        .download-attendance-button {
            background-color: #10b981;
        }
        .download-attendance-button:not(:disabled):hover {
            background-color: #059669;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-8">

    <div class="flex flex-col items-center p-4 bg-white rounded-xl shadow-lg mb-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">Student Timetable Lookup</h1>
        <p class="text-gray-600 mb-6 text-center">Enter your Student ID to view your specific course timetable.</p>
        
        <div class="w-full max-w-2xl flex flex-col items-center space-y-4">
            <!-- ID Input Row -->
            <div class="w-full">
                <label for="student-id-input" class="block text-gray-700 text-sm font-bold mb-2">Student ID:</label>
                <input type="text" id="student-id-input" placeholder="e.g., 20368757" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline transition duration-200">
            </div>
            
            <button id="lookup-btn" class="action-button shadow-lg w-full">
                Show Timetable
            </button>
            
            <p id="message-display" class="text-red-600 font-medium hidden text-center w-full mt-2" role="alert"></p>
            
            <!-- Button Row -->
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 w-full pt-4">
                <button id="download-btn" class="download-button w-full sm:w-1/2" disabled>
                    Download Timetable PDF
                </button>
                <!--<button id="download-attendance-btn" class="download-button download-attendance-button w-full sm:w-1/2" disabled>
                    Download Attendance Card
                </button>-->
            </div>
        </div>
    </div>

    <div id="timetable-display" class="hidden">
        <h2 id="course-title" class="text-2xl font-semibold text-gray-700 mb-4 mt-8"></h2>
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <div id="timetable-container" class="container">
                <canvas id="timetable-canvas" width="1000" height="600"></canvas>
            </div>
        </div>
    </div>

    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module">
        import { idMapCSVContent } from './student-group.js';
        import { timetableCSVContent } from './student-group.js';

        document.addEventListener('DOMContentLoaded', () => {
            const studentIdInput = document.getElementById('student-id-input');
            const lookupBtn = document.getElementById('lookup-btn');
            const downloadBtn = document.getElementById('download-btn');
            const downloadAttendanceBtn = document.getElementById('download-attendance-btn');
            const timetableDisplay = document.getElementById('timetable-display');
            const courseTitleElement = document.getElementById('course-title');
            const messageDisplay = document.getElementById('message-display');
            const canvas = document.getElementById('timetable-canvas');
            const ctx = canvas.getContext('2d');
            
            let timetableData = [];
            let idToCourseMap = {};
            let currentCourse = null;

            // Drawing constants for Canvas
            const timeHeaderWidth = 80;
            const dayHeaderHeight = 40;
            const timeSlots = [
                '9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'
            ];
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const minutesInSlot = 30;

            // Helper function: parse time string like "9:00" and return minutes from midnight
            function parseTime(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            // Helper function: convert 12-hour time string to 24-hour time string
            function convert12hrTo24hr(timeStr) {
                let [hours, minutes] = timeStr.split(':').map(Number);
                // Adjust for PM times (assuming times like 1:00 to 8:00 are PM)
                if (hours >= 1 && hours <= 8) {
                    hours += 12;
                }
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }

            // --- DATA PROCESSING FUNCTIONS ---

            // Function to process the main timetable CSV content
            function processTimetableCSV(csvString) {
                const rows = csvString.trim().split('\n').map(row => row.split(',').map(cell => cell.replace(/"/g, '')));
                const headers = rows[0];
                timetableData = rows.slice(1).map(row => {
                    const event = {};
                    headers.forEach((header, index) => {
                        event[header.trim()] = row[index] ? row[index].trim() : '';
                    });
                    event.length = parseFloat(event.length);
                    return event;
                });
            }

            // Function to process the Student ID to Course Map CSV content (FIXED)
            function processIdMapCSV(csvString) {
                const map = {};
                // Split by newline (handling both \r\n and \n)
                const rows = csvString.trim().split(/\r?\n/).filter(line => line.trim() !== '');

                // Skip the header row
                const dataRows = rows.slice(1);
                
                dataRows.forEach(rowString => {
                    // Split the row by comma. This is simple and reliable for getting the first and last column,
                    // even if quoted fields with internal commas break the middle columns.
                    // split on tab was ,
                    const cells = rowString.split('\t'); 
                    
                    if (cells.length > 1) {
                        // Extract the first cell (ID) and the last cell (Course)
                        // Then clean them of quotes and excess whitespace.
                        const studentId = cells[0].replace(/"/g, '').trim();
                        const courseId = cells[cells.length - 1].replace(/"/g, '').trim();

                        if (studentId && courseId) {
                            map[studentId] = courseId;
                        }
                    }
                });
                return map;
            }
            
            // --- CANVAS DRAWING FUNCTION ---
            function drawTimetable(course) {
                currentCourse = course; // Store the current course
                messageDisplay.classList.add('hidden');
                
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Calculate cell dimensions dynamically
                const timeCellWidth = (canvas.width - timeHeaderWidth) / (timeSlots.length * 2);
                const dayCellHeight = (canvas.height - dayHeaderHeight) / days.length;

                // Draw headers
                ctx.fillStyle = '#1f2937';
                ctx.font = '600 14px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // Draw time headers
                timeSlots.forEach((slot, index) => {
                    ctx.save();
                    ctx.translate(timeHeaderWidth + index * timeCellWidth * 2 + timeCellWidth, dayHeaderHeight / 2);
                    ctx.fillStyle = '#1f2937';
                    ctx.fillText(slot, 0, 0);
                    ctx.restore();
                });
                
                // Draw day labels
                ctx.fillStyle = '#4b5563';
                ctx.font = '600 14px Inter, sans-serif';
                ctx.textAlign = 'left';
                days.forEach((day, index) => {
                    ctx.save();
                    ctx.translate(10, dayHeaderHeight + index * dayCellHeight + dayCellHeight / 2);
                    ctx.fillStyle = '#4b5563';
                    ctx.fillText(day, 0, 0);
                    ctx.restore();
                });

                // Draw grid lines (horizontal and vertical)
                ctx.strokeStyle = '#e5e7eb';
                
                // Horizontal lines
                for (let i = 0; i <= days.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(timeHeaderWidth, dayHeaderHeight + i * dayCellHeight);
                    ctx.lineTo(canvas.width, dayHeaderHeight + i * dayCellHeight);
                    ctx.stroke();
                }

                // Vertical lines (at the beginning of each hour)
                for (let i = 0; i < timeSlots.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(timeHeaderWidth + i * timeCellWidth * 2, dayHeaderHeight);
                    ctx.lineTo(timeHeaderWidth + i * timeCellWidth * 2, canvas.height);
                    ctx.stroke();
                }

                // Draw events
                const courseEvents = timetableData.filter(event => event.course === course);
                courseEvents.forEach(event => {
                    const timeParts = event.time.split(' - ');
                    const startTime24hr = convert12hrTo24hr(timeParts[0]);
                    const endTime24hr = convert12hrTo24hr(timeParts[1]);
                    const formattedTime = `${startTime24hr} - ${endTime24hr}`;

                    const startTimeMinutes = parseTime(startTime24hr);
                    const dayIndex = parseInt(event.day) - 1;

                    if (dayIndex >= 0 && dayIndex < days.length) {
                        const startMinutesFrom9am = startTimeMinutes - parseTime('9:00');
                        const startSlotIndex = startMinutesFrom9am / minutesInSlot;
                        const durationInMinutes = event.length * 60;
                        const durationInSlots = durationInMinutes / minutesInSlot;

                        const x = timeHeaderWidth + startSlotIndex * timeCellWidth;
                        const y = dayHeaderHeight + dayIndex * dayCellHeight;
                        const width = durationInSlots * timeCellWidth;
                        const height = dayCellHeight;

                        // Draw event rectangle
                        ctx.fillStyle = '#1e40af'; // Darker blue fill
                        ctx.strokeStyle = '#2563eb';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.roundRect(x + 2, y + 2, width - 4, height - 4, 8);
                        ctx.fill();
                        ctx.stroke();

                        // Draw event text
                        ctx.fillStyle = '#ffffff';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'top';
                        
                        const textX = x + 10;
                        const textY = y + 8;
                        const lineHeight = 16;

                        // Main unit/course name
                        ctx.font = '600 14px Inter, sans-serif';
                        ctx.fillText(event.unit, textX, textY);
                        
                        // Time, lecturer, and room
                        ctx.font = '500 11px Inter, sans-serif';
                        ctx.fillText(formattedTime, textX, textY + lineHeight + 2);
                        ctx.fillText(`Lecturer: ${event.lecturer}`, textX, textY + lineHeight * 2 + 2);
                        ctx.fillText(`Room: ${event.room}`, textX, textY + lineHeight * 3 + 2);
                    }
                });
                
                courseTitleElement.textContent = `Timetable for Course: ${course}`;
                timetableDisplay.classList.remove('hidden');
                downloadBtn.disabled = false;
                //downloadAttendanceBtn.disabled = false;
            }

            // --- PDF DRAWING HELPER FUNCTION (Draws one visual timetable card) ---
            function drawAttendanceTimetable(doc, course, yOffset) {
                const margin = 10;
                const docWidth = doc.internal.pageSize.getWidth();
                const cardWidth = docWidth - 2 * margin; // 190mm for A4 portrait
                const cardHeight = 100; // Height for one card

                let currentY = yOffset;

                // 1. ID, Name, Date Header
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(50, 50, 50);

                const headerLineHeight = 6;
                doc.setFont(undefined, 'bold');
                doc.text(`Course ID: ${course}`, margin, currentY);
                doc.setFont(undefined, 'normal');
                currentY += headerLineHeight;
                doc.text(`ID: ______________________`, margin, currentY);
                doc.text(`Student Name: ______________`, docWidth / 2, currentY);
                currentY += headerLineHeight;
                doc.text(`Date: ____________________`, margin, currentY);
                currentY += headerLineHeight - 1; // Slight space reduction before grid starts

                const gridYStart = currentY;
                const dayHeaderHeight = 8; // Reduced height for time heading
                const timeSlots = ['9:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'];
                const timeHeaderWidth = 20;
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                const dayCellHeight = (cardHeight - dayHeaderHeight) / days.length; 
                const timeCellWidth = (cardWidth - timeHeaderWidth) / (timeSlots.length * 2);

                // 2. Draw Grid and Headers
                
                // Draw outline box
                doc.setDrawColor(0);
                doc.setLineWidth(0.5);
                doc.rect(margin, gridYStart, cardWidth, cardHeight);

                // Draw day labels (vertical header)
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.text('Day', margin + timeHeaderWidth / 2, gridYStart + dayHeaderHeight / 2, { align: 'center' });
                doc.setLineWidth(0.2); // Thinner line for grid
                
                // Horizontal lines (for days)
                days.forEach((day, index) => {
                    const y = gridYStart + dayHeaderHeight + index * dayCellHeight;
                    // Draw day name
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(day.substring(0, 3), margin + timeHeaderWidth / 2, y + dayCellHeight / 2, { align: 'center' });
                    // Draw day divider line
                    doc.line(margin, y, margin + cardWidth, y); 
                });
                
                // Vertical line for day header
                doc.line(margin + timeHeaderWidth, gridYStart, margin + timeHeaderWidth, gridYStart + cardHeight);

                // Draw time headers (horizontal top header)
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                timeSlots.forEach((slot, index) => {
                    const x = margin + timeHeaderWidth + index * timeCellWidth * 2 + timeCellWidth;
                    doc.text(slot, x, gridYStart + dayHeaderHeight / 2, { align: 'center' });
                    
                    // Vertical lines (at the beginning of each hour)
                    const xHourLine = margin + timeHeaderWidth + index * timeCellWidth * 2;
                    doc.line(xHourLine, gridYStart, xHourLine, gridYStart + cardHeight);
                    
                    // Vertical lines for half-hour slots
                    const xHalfHourLine = xHourLine + timeCellWidth;
                    if (index < timeSlots.length - 1) { 
                         doc.setLineDash([1, 1], 0); // Dashed line for half hour
                         doc.line(xHalfHourLine, gridYStart + dayHeaderHeight, xHalfHourLine, gridYStart + cardHeight);
                         doc.setLineDash(0, 0); // Solid line reset
                    }
                });
                
                // Horizontal line for time header base
                doc.line(margin, gridYStart + dayHeaderHeight, margin + cardWidth, gridYStart + dayHeaderHeight);


                // 3. Draw Events (Unit Name only, top-left alignment)
                const minutesInSlot = 30;
                const courseEvents = timetableData
                    .filter(event => event.course === course);

                courseEvents.forEach(event => {
                    const timeParts = event.time.split(' - ');
                    const startTime24hr = convert12hrTo24hr(timeParts[0]);

                    const startTimeMinutes = parseTime(startTime24hr);
                    const dayIndex = parseInt(event.day) - 1;

                    if (dayIndex >= 0 && dayIndex < days.length) {
                        const startMinutesFrom9am = startTimeMinutes - parseTime('9:00');
                        const startSlotIndex = startMinutesFrom9am / minutesInSlot;
                        const durationInMinutes = event.length * 60;
                        const durationInSlots = durationInMinutes / minutesInSlot;

                        const x = margin + timeHeaderWidth + startSlotIndex * timeCellWidth;
                        const y = gridYStart + dayHeaderHeight + dayIndex * dayCellHeight;
                        const width = durationInSlots * timeCellWidth;
                        const height = dayCellHeight;

                        // Draw event box outline and WHITE fill (R:255, G:255, B:255)
                        doc.setDrawColor(30, 30, 30);
                        doc.setFillColor(255, 255, 255); // White fill requested
                        doc.setLineWidth(0.4);
                        doc.rect(x + 0.5, y + 0.5, width - 1, height - 1, 'FD');

                        // Unit Text (Top-Left aligned)
                        doc.setTextColor(30, 30, 30);
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(7);
                        
                        const textMarginX = 1; // Small horizontal padding
                        const textMarginY = 2.5; // Small vertical padding from the top edge of the cell
                        
                        doc.text(event.unit, x + textMarginX, y + textMarginY, { align: 'left', baseline: 'top' });
                    }
                });
            }

            // Function to generate the Visual Attendance Card PDF (Two per page)
            function generateAttendanceCardPDF(course) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4'); // Portrait mode

                // Draw the first timetable (top half) - starting at 10mm
                drawAttendanceTimetable(doc, course, 10);

                // Draw the second timetable (bottom half) - starting at 130mm
                drawAttendanceTimetable(doc, course, 130); 
                
                doc.save(`attendance-card-visual-${course}.pdf`);
            }

            // --- MAIN LOGIC ---

            // CSV Content for Student ID to Course Group mapping (Groups for TT yr1.csv)

            idToCourseMap = processIdMapCSV(idMapCSVContent);

            // CSV Content for the Timetable Data

            processTimetableCSV(timetableCSVContent);

            function showMessage(text, isError = true) {
                messageDisplay.textContent = text;
                messageDisplay.classList.remove('hidden', 'text-green-600', 'text-red-600');
                messageDisplay.classList.add(isError ? 'text-red-600' : 'text-green-600');
            }

            function resetDisplay() {
                timetableDisplay.classList.add('hidden');
                downloadBtn.disabled = true;
                //downloadAttendanceBtn.disabled = true;
                courseTitleElement.textContent = '';
                messageDisplay.classList.add('hidden');
                currentCourse = null;
            }

            function handleLookup() {
                const studentId = studentIdInput.value.trim();
                resetDisplay();

                if (!studentId) {
                    showMessage("Please enter a Student ID.", true);
                    return;
                }
                
                // Lookup course based on student ID
                const course = idToCourseMap[studentId];

                if (course) {
                    // Check if timetable data exists for this course
                    const hasEvents = timetableData.some(event => event.course === course);
                    if (hasEvents) {
                        drawTimetable(course);
                        showMessage(`Timetable found for Course: ${course}`, false);
                    } else {
                        showMessage(`Course ${course} found for ID, but no timetable data is available.`, true);
                    }
                } else {
                    showMessage(`Student ID ${studentId} not found. Please check the ID.`, true);
                }
            }
            
            // Event listener for the "Show Timetable" button
            lookupBtn.addEventListener('click', handleLookup);

            // Allow lookup on Enter key press in the input field
            studentIdInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleLookup();
                }
            });


            // Event listener for the download Timetable PDF button (Original logic)
            downloadBtn.addEventListener('click', () => {
                if (currentCourse) {
                    const doc = new window.jspdf.jsPDF('l', 'mm', 'a4'); // 'l' for landscape mode
                    const canvasImage = canvas.toDataURL('image/png', 1.0);
                    
                    const imgWidth = 297; 
                    const pageHeight = 210; 
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;

                    let position = 0;

                    doc.addImage(canvasImage, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(canvasImage, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    const filename = `timetable-${currentCourse}.pdf`;
                    doc.save(filename);
                }
            });

            // Event listener for the download Attendance Card button (New visual logic)
            /*downloadAttendanceBtn.addEventListener('click', () => {
                if (currentCourse) {
                    generateAttendanceCardPDF(currentCourse);
                }
            });*/
            
            // Initialize with the input focused
            studentIdInput.focus();
        });
    </script>
</body>
</html>




